<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RPGクリッカー：完全版</title>

<style>
* { touch-action: manipulation; user-select: none; }

body {
  text-align: center;
  font-family: sans-serif;
  background-color: #121212;
  color: #e0e0e0;
  padding: 20px;
}

.header {
  display: flex;
  justify-content: space-around;
  background: #1e1e1e;
  padding: 15px;
  border-radius: 15px;
  margin-bottom: 20px;
}

.stat-box { display: flex; flex-direction: column; }
.xp-value { font-size: 24px; color: #3498db; font-weight: bold; }
.money-value { font-size: 24px; color: #f1c40f; font-weight: bold; }

#xp-bar-container {
  width: 200px; height: 10px;
  background: #333; border-radius: 5px;
  margin: 5px auto;
}
#xp-bar { height: 100%; background: #3498db; transition: 0.3s; }

.main-btn {
  position: relative;
  width: 150px; height: 150px;
  border-radius: 50%;
  border: none;
  background: #2980b9;
  color: white;
  font-size: 20px;
  margin: 15px;
  cursor: pointer;
  overflow: hidden;
}

.ripple {
  position: absolute;
  border-radius: 50%;
  background: rgba(255,255,255,0.4);
  transform: scale(0);
  animation: ripple 0.6s linear;
  pointer-events: none;
}
@keyframes ripple {
  to { transform: scale(4); opacity: 0; }
}

.gain-text {
  position: absolute;
  color: #f1c40f;
  font-weight: bold;
  pointer-events: none;
  animation: floatUp 1s ease-out forwards;
}
@keyframes floatUp {
  from { opacity: 1; transform: translate(-50%,0); }
  to { opacity: 0; transform: translate(-50%,-40px); }
}

#buff-container {
  max-width: 300px;
  margin: 10px auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.buff {
  background: #1e1e1e;
  border: 1px solid #555;
  border-radius: 8px;
  padding: 8px;
  display: flex;
  justify-content: space-between;
}

.shop {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  max-width: 800px;
  margin: 20px auto;
}

.item { background:#1e1e1e; padding:15px; border-radius:12px; display:none; }
.item.unlocked { display:block; }
.item button { margin-top:8px; cursor:pointer; padding:5px 10px; background:#2980b9; color:white; border:none; border-radius:5px; }

.item .desc {
  margin-top:8px;
  font-size:13px;
  color:#bdbdbd;
  line-height:1.3;
}

#boss-area {
  display:none;
  background:#1e1e1e;
  padding:15px;
  border-radius:15px;
  margin:15px auto;
  max-width:300px;
}

button.shop-btn {
  margin-top:10px;
  padding:10px 20px;
  background:#2980b9;
  color:white;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-size:16px;
}
</style>
</head>

<body>

<div class="header">
  <div class="stat-box">
    <span>LEVEL</span>
    <span class="xp-value">Lv.<span id="level">1</span></span>
    <div id="xp-bar-container"><div id="xp-bar"></div></div>
  </div>
  <div class="stat-box">
    <span>MONEY</span>
    <span class="money-value"><span id="pts">0</span> G</span>
  </div>
</div>

<button class="main-btn" onclick="performClick(event)">CLICK!</button>
<div id="buff-container"></div>

<button class="shop-btn" id="boss-start-btn" onclick="startBoss()">⚔️ ボスに挑む</button>

<div id="boss-area">
  <h3>ゴブリン王</h3>
  <div id="boss-rank"></div>
  <div id="boss-hp-text"></div>
  <div style="background:#333;height:10px;border-radius:5px;">
    <div id="boss-hp-bar" style="height:100%;background:#e74c3c;"></div>
  </div>
  <div id="boss-timer"></div>
  <button class="main-btn" style="background:#c0392b" onclick="attackBoss(event)">ATTACK!</button>
</div>

<div class="shop">
  <div class="item unlocked" id="item1">
    木刀
    <button onclick="buyItem(1,50)">50G</button>
    <div class="desc">攻撃力 +1。序盤の基本武器。</div>
  </div>

  <div class="item" id="item2">
    見習い召喚師
    <button onclick="buyItem(2,200)">200G</button>
    <div class="desc">毎秒 +1G 自動生成。Lv3で解禁。</div>
  </div>

  <div class="item" id="item3">
    銀の剣
    <button onclick="buyItem(3,800)">800G</button>
    <div class="desc">攻撃力 +3。中級武器。Lv5で解禁。</div>
  </div>

  <div class="item" id="item4">
    ドラゴンの巣
    <button onclick="buyItem(4,5000)">5000G</button>
    <div class="desc">自動生成 +5。Lv10で解禁。</div>
  </div>

  <div class="item" id="item5">
    Wブースト
    <button onclick="buyItem(5,3000)">3000G</button>
    <div class="desc">10秒間ダブルブースト。</div>
  </div>
</div>

  <div class="item" id="item6">
    両刃斧
    <button onclick="buyItem(6,1500)">1500G</button>
    <div class="desc">攻撃力 +10。強力な武器。Lv12で解禁。</div>
  </div>
</div>

<script>
let gameData = {
  pts: 0,
  xp: 0,
  level: 1,
  power: 1,
  autoAmount: 0,
  boostUntil: 0,
  rebirth: 0
};

let bossData = {
  active: false,
  baseHp: 1000,
  hp: 1000,
  maxHp: 1000,
  time: 10,
  timer: null
};

/* 効果音システム */
let audioCtx = null;

function initAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playSE(frequency, duration = 0.1, volume = 0.3){
  try{
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    
    osc.frequency.value = frequency;
    osc.type = 'sine';
    
    gain.gain.setValueAtTime(volume, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.start(audioCtx.currentTime);
    osc.stop(audioCtx.currentTime + duration);
  }catch(e){
    console.log("効果音再生エラー:", e);
  }
}

const playClickSound = () => playSE(700, 0.05, 0.2);
const playBossStartSound = () => playSE(200, 0.3, 0.3);
const playAttackSound = () => playSE(900, 0.08, 0.25);
const playBossWinSound = () => playSE(1200, 0.3, 0.3);
const playBossLoseSound = () => playSE(150, 0.4, 0.3);

function saveGame(){
  localStorage.setItem("clickerSave", JSON.stringify(gameData));
}

function loadGame(){
  const s = localStorage.getItem("clickerSave");
  if(s){
    try{
      gameData = Object.assign(gameData, JSON.parse(s));
    }catch(e){
      console.log("セーブデータ読み込みエラー:", e);
    }
  }
}

const format = n => {
  if(isNaN(n) || !isFinite(n)) return "0";
  return Math.floor(n).toLocaleString();
};
const getNextXP = lv => Math.floor(100 * Math.pow(1.5, lv - 1));

function updateDisplay(){
  let need = getNextXP(gameData.level);
  while(gameData.xp >= need){
    gameData.xp -= need;
    gameData.level++;
    need = getNextXP(gameData.level);
  }
  
  document.getElementById("pts").innerText = format(gameData.pts);
  document.getElementById("level").innerText = gameData.level;
  document.getElementById("xp-bar").style.width = (gameData.xp / need * 100) + "%";
  
  const items = [
    document.getElementById("item1"),
    document.getElementById("item2"), 
    document.getElementById("item3"),
    document.getElementById("item4"),
    document.getElementById("item5"),
    document.getElementById("item6")
  ];
  
  if(gameData.level >= 3) items[1].classList.add("unlocked");
  if(gameData.level >= 5) items[2].classList.add("unlocked");
  if(gameData.level >= 10) items[3].classList.add("unlocked");
  if(gameData.level >= 12) items[5].classList.add("unlocked");
  if(gameData.level >= 15) items[4].classList.add("unlocked");
  
  document.getElementById("boss-start-btn").disabled = gameData.level < 10;
  saveGame();
}

function updateBuffDisplay(){
  const buffContainer = document.getElementById("buff-container");
  buffContainer.innerHTML = "";
  if(gameData.boostUntil > Date.now()){
    buffContainer.innerHTML = `<div class="buff"><span>Wブースト</span><span>${Math.ceil((gameData.boostUntil - Date.now()) / 1000)}s</span></div>`;
  }
}

function performClick(e){
  const boost = Date.now() < gameData.boostUntil ? 2 : 1;
  const gain = Math.floor(gameData.power * boost * (1 + gameData.rebirth * 0.2));

  gameData.pts = (gameData.pts || 0) + gain;
  gameData.xp = (gameData.xp || 0) + gain * 2;

  const r = document.createElement("span");
  r.className = "ripple";
  const rect = e.currentTarget.getBoundingClientRect();
  r.style.width = r.style.height = rect.width + "px";
  r.style.left = (e.clientX - rect.left - rect.width / 2) + "px";
  r.style.top = (e.clientY - rect.top - rect.height / 2) + "px";
  e.currentTarget.appendChild(r);
  setTimeout(() => r.remove(), 600);

  const g = document.createElement("div");
  g.className = "gain-text";
  g.innerText = "+" + format(gain) + " G";
  g.style.left = e.clientX + "px";
  g.style.top = e.clientY + "px";
  document.body.appendChild(g);
  setTimeout(() => g.remove(), 1000);

  playClickSound();
  updateDisplay();
}

function startBoss(){
  bossData.maxHp = Math.floor(1000 * (1 + gameData.rebirth * 0.5));
  bossData.hp = bossData.maxHp;
  bossData.active = true;
  bossData.time = Math.max(5, 10 - gameData.rebirth);
  
  document.getElementById("boss-area").style.display = "block";
  document.getElementById("boss-start-btn").disabled = true;

  playBossStartSound();
  updateBossUI();
  
  clearInterval(bossData.timer);
  bossData.timer = setInterval(() => {
    bossData.time--;
    updateBossUI();
    if(bossData.time <= 0) endBoss(false);
  }, 1000);
}

function attackBoss(e){
  if(!bossData.active) return;
  const dmg = Math.floor(gameData.power * (1 + gameData.rebirth * 0.2));
  bossData.hp -= dmg;
  playAttackSound();
  if(bossData.hp <= 0) endBoss(true);
  updateBossUI();
}

function updateBossUI(){
  const currentHp = Math.max(0, Math.floor(bossData.hp));
  
  document.getElementById("boss-hp-text").innerText = `HP ${format(currentHp)}/${format(bossData.maxHp)}`;
  document.getElementById("boss-hp-bar").style.width = Math.max(0, Math.min(100, (currentHp / bossData.maxHp * 100))) + "%";
  document.getElementById("boss-timer").innerText = `残り ${Math.max(0, bossData.time)}s`;
  document.getElementById("boss-rank").innerText = `強化段階 ★${gameData.rebirth}`;
}

function endBoss(win){
  clearInterval(bossData.timer);
  bossData.active = false;
  document.getElementById("boss-area").style.display = "none";
  document.getElementById("boss-start-btn").disabled = false;
  
  if(win){
    gameData.pts = (gameData.pts || 0) + Math.floor(3000 * (1 + gameData.rebirth * 0.2));
    gameData.xp = (gameData.xp || 0) + 500;
    playBossWinSound();
  }else{
    gameData.pts = Math.max(0, (gameData.pts || 0) - 300);
    playBossLoseSound();
  }
  updateDisplay();
}

function buyItem(id, cost){
  if(gameData.pts < cost){
    alert("お金が足りません");
    return;
  }
  gameData.pts -= cost;
  switch(id){
    case 1: gameData.power += 1; break;
    case 2: gameData.autoAmount += 1; break;
    case 3: gameData.power += 3; break;
    case 4: gameData.autoAmount += 5; break;
    case 5: gameData.boostUntil = Date.now() + 10000; break;
    case 6: gameData.power += 10; break;
  }
  updateDisplay();
}

// 初期化処理
loadGame();
updateDisplay();

// 自動更新ループ
setInterval(() => {
  if(gameData.autoAmount > 0 && !bossData.active){
    gameData.pts = (gameData.pts || 0) + gameData.autoAmount;
    updateDisplay();
  }
  updateBuffDisplay();
}, 1000);

window.addEventListener("beforeunload", saveGame);
</script>

</body>
</html>